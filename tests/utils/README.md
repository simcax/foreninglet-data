# VCR Data Anonymization Tools

This directory contains utilities for anonymizing VCR cassette files containing ForeningLet API data to ensure no personal or sensitive information is included in test files.

## Overview

When working with real API data for testing, it's crucial to anonymize personal information before committing test files to version control. These tools help you create realistic but fake test data that maintains the structure and relationships needed for proper testing.

## Available Tools

### 1. Activity Data Anonymizer (`anonymize_fl_activity_data.py`)

Anonymizes VCR cassette files containing ForeningLet API activity data.

#### Features

- **Complete VCR File Processing**: Handles YAML VCR cassette files with HTTP request/response interactions
- **Smart Data Anonymization**: Replaces sensitive data while maintaining realistic patterns
- **Structure Preservation**: Keeps data relationships and formats needed for tests
- **Automatic Output Naming**: By default, creates output files in the same directory with `_anon` suffix
- **Batch Processing**: Can process individual files or entire directories
- **CLI and Python API**: Use from command line or import as a module

#### What Gets Anonymized

- **Activity Names**: Replaced with realistic Danish activity types (memberships, roles, etc.)
- **Prices**: Fake amounts while preserving currency formatting
- **Age Ranges**: Realistic but fake age ranges and birth year calculations
- **Department IDs**: Mapped to generic department identifiers
- **Authorization Data**: API keys and tokens replaced with dummy values
- **Session Data**: Session cookies and IDs anonymized
- **Contact Information**: Email addresses and phone numbers replaced
- **Personal Text**: Any personal information in descriptions or notes

#### Usage

##### Command Line Interface

```bash
# Show help and usage information
python -m tests.utils.anonymize_fl_activity_data --help
# OR
uv run python -m tests.utils.anonymize_fl_activity_data --help

# Anonymize a single VCR file (creates input_file_anon.yaml by default)
python -m tests.utils.anonymize_fl_activity_data tests/cassettes/original.yaml

# Specify custom output location
python -m tests.utils.anonymize_fl_activity_data tests/cassettes/original.yaml custom_anonymized.yaml

# Using uv (recommended for this project)
uv run python -m tests.utils.anonymize_fl_activity_data tests/cassettes/test.yaml

# Example with real file from the project
uv run python -m tests.utils.anonymize_fl_activity_data tests/vcr_cassettes/test_data_fl_api_activities_anon.yaml
```

##### Python API

```python
from pathlib import Path
from tests.utils.anonymize_fl_activity_data import anonymize_vcr_file

# Basic usage - uses default output naming
input_file = Path("tests/cassettes/original_data.yaml")
success = anonymize_vcr_file(input_file)
# Creates: tests/cassettes/original_data_anon.yaml (same directory, "_anon" suffix)

# Custom output location
output_file = Path("tests/cassettes/anonymized_data.yaml")
success = anonymize_vcr_file(input_file, output_file)

# Check result
if success:
    print("✅ Anonymization completed successfully")
else:
    print("❌ Anonymization failed")
```

#### Input/Output Format

**Input**: VCR YAML files with structure like:
```yaml
interactions:
- request:
    method: GET
    uri: https://foreninglet.dk/api/activities?version=1
    headers:
      authorization: [actual-api-key]
  response:
    body:
      string: '[{"ActivityId":"12345","Name":"Real Activity Name",...}]'
    headers:
      Set-Cookie: [real-session-id]
```

**Output**: Anonymized YAML files with:
```yaml
# Anonymized test data - generated by anonymize_fl_activity_data.py
interactions:
- request:
    method: GET
    uri: https://foreninglet.dk/api/activities?version=1
    headers:
      authorization: [DUMMY]
  response:
    body:
      string: '[{"ActivityId":"12345","Name":"Halvårs medlemsskab",...}]'
    headers:
      Set-Cookie: [anonymized-session-id]
```

### 2. Member Data Anonymizer (`anonymize_fl_api_data.py`)

Anonymizes VCR cassette files containing ForeningLet API member data.

#### Features

- Comprehensive member data anonymization
- Generates realistic Danish fake data using Faker
- Preserves data relationships and structures
- Command line interface with Typer

## Installation

These tools are included with the project's development dependencies. If you need to install them separately:

```bash
# All dependencies are included in the project's dev dependencies
uv sync

# Or install individual packages if needed
uv add --group dev faker typer pyyaml
```

**Note**: The anonymizer works with the project's existing uv environment. Use `uv run` to ensure all dependencies are available.

## Best Practices

### 1. Always Anonymize Before Committing

Never commit VCR files with real personal data. Always run anonymization before adding files to git:

```bash
# Anonymize before committing
uv run python -m tests.utils.anonymize_fl_activity_data tests/cassettes/new_recording.yaml
# This creates: tests/cassettes/new_recording_anon.yaml
git add tests/cassettes/new_recording_anon.yaml
```

### 2. Use Consistent Naming

The anonymizer follows a consistent naming convention:
- **Input file**: `test_name.yaml` (original recording)
- **Default output**: `test_name_anon.yaml` (same directory, `_anon` suffix added)
- **Custom output**: Use `--output-file` or `output_file_path` parameter for custom locations

### 3. Verify Test Compatibility

After anonymization, run your tests to ensure the fake data maintains the necessary structure:

```bash
uv run pytest tests/ -v
```

### 4. Review Output

Always review anonymized files to ensure:
- No real personal information remains
- Test data maintains realistic patterns
- Data relationships are preserved

## File Structure

```
tests/utils/
├── README.md                           # This file
├── anonymize_fl_activity_data.py       # Activity data anonymizer
└── anonymize_fl_api_data.py           # Member data anonymizer
```

## Security Notes

- **Never commit real API keys**: Always use dummy values in test files
- **Review anonymized output**: Check that all sensitive data has been replaced
- **Test with fake data**: Ensure your tests work with anonymized data
- **Regular audits**: Periodically review test files for any leaked personal information

## Contributing

When adding new anonymization features:

1. Maintain backward compatibility with existing VCR structures
2. Add comprehensive documentation for new anonymization rules
3. Include examples of input/output data
4. Test thoroughly to ensure no personal data leakage
5. Follow the existing code style and patterns
6. Test CLI functionality with both `python -m` and `uv run` approaches
7. Update this README with any new usage patterns or commands

### Testing Changes

```bash
# Test the anonymizer
uv run python -m tests.utils.anonymize_fl_activity_data --help

# Test with a real file
uv run python -m tests.utils.anonymize_fl_activity_data tests/vcr_cassettes/test_data_fl_api_activities_anon.yaml

# Verify tests still pass
uv run pytest tests/ -v
```

## Troubleshooting

### Common Issues

**"File not found" errors**:
- Ensure the input file path is correct and relative to the project root
- Check file permissions
- Verify you're running from the correct directory

**"ModuleNotFoundError" or import errors**:
- Use `uv run` instead of plain `python` to ensure dependencies are available
- Verify you're in the project root directory

**"JSON decode error"**:
- Verify the VCR file contains valid YAML/JSON
- Check for malformed API responses in the original recording
- Ensure the file hasn't been corrupted

**Tests failing after anonymization**:
- Review the anonymized data structure
- Ensure critical data relationships are preserved
- Check that fake data matches expected formats
- Run `uv run pytest` to validate tests still pass with anonymized data

### Getting Help

If you encounter issues with the anonymization tools:

1. Check that all dependencies are installed
2. Verify input file format matches expected VCR structure
3. Review the console output for specific error messages
4. Test with a minimal example file first